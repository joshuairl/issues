#!/usr/bin/env node

/**
 * Module dependencies.
 */
var fs = require('fs');
var path = require('path');
var ini = require('ini');

/**
 * Help params.
 * 
 * @type {Object}
 */
var params = require('../lib/params');

/**
 * Argv.
 * 
 * @type {Object}
 */
var argv = require('optimist').options(params).argv;

/**
 * The request dispatcher.
 * 
 * @type {Function}
 */
var Dispatcher = require('../lib/dispatcher');

/**
 * Dispatcher instance.
 * 
 * @type {Object}
 */
var dispatcher = null;

/**
 * Error alias.
 * 
 * @type {Function}
 */
var error = console.error;

/**
 * The git config file path.
 * 
 * @type {String}
 */
var file = null;

/**
 * Current location.
 * 
 * @type {String}
 */
var location = process.cwd();

while (!file) {
  if (path.existsSync(location + '/.git/config')) file = location + '/.git/config';
  else if (location !== '/') location = path.dirname(location);
  else throw new Error('.git/config can not be located.');
}

/**
 * Git config.
 * 
 * @type {String}
 */
var config = ini.parse(fs.readFileSync(file, 'utf-8'));

/**
 * The remote source.
 * 
 * @type {Object}
 */
var source = config['remote "upstream"'] || config['remote "origin"'];

// Checks if anything was found.
if (!source) throw new Error('Orgin/upstream was not found.');

/**
 * User + repo.
 * 
 * @type {Object}
 */
var result = source.url.match(/(:|\/)([^\/]+)\/([^\/]+)\.git/);

// Repo.
argv._.unshift(result[3]);

// Username.
argv._.unshift(result[2]);

// Handles exceptions.
process.on('uncaughtException', function(err) {
  error(err.message);
  process.exit(1);
});

// Dispatches the request.
dispatcher = new Dispatcher(argv).run();